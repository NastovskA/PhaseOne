@model PhaseOne.Models.CourseEnrollmentViewModel

<div class="enrollment-container">

    <div class="header-section">
        <h2 class="page-title">
            Запишување студенти - @ViewBag.CourseTitle
        </h2>
        <div class="course-info">
            <span>ИД на предмет: @Model.CourseId</span>
        </div>
    </div>

    <form asp-action="AdminUpdateEnrollments" method="post" class="enrollment-form" id="enrollmentForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="courseId" value="@Model.CourseId" />

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Академска година</label>
                <input type="number" name="year" value="@Model.Year" class="form-input"
                       min="2000" max="2030" required />
                <div class="form-hint">Внесете ја академската година (пр. 2024)</div>
            </div>

            <div class="form-group">
                <label class="form-label">Семестар</label>
                <select name="semester" class="form-select" required>
                    <option value="">Изберете семестар</option>
                    <option value="Winter" selected="@("Winter" == Model.Semester)">Зимски семестар</option>
                    <option value="Summer" selected="@("Summer" == Model.Semester)">Летен семестар</option>
                </select>
                <div class="form-hint">Изберете семестар за запишување</div>
            </div>
        </div>

        <div class="section-header">
            <h4 class="section-title">
                Достапни студенти (@Model.Students.Count вкупно)
            </h4>

            <div class="selection-controls">
                <div class="select-all-container">
                    <input type="checkbox" id="selectAll" class="select-all-checkbox" />
                    <label for="selectAll" class="select-all-label">Избери ги сите</label>
                </div>
                <div class="selected-count">
                    <span id="selectedCount">0</span> студенти избрани
                </div>
            </div>
        </div>

        <div class="students-container">
            @if (Model.Students.Any())
            {
                <div class="students-list" id="studentsList">
                    @foreach (var s in Model.Students)
                    {
                        <div class="student-item" data-student-id="@s.StudentId">
                            <input type="checkbox" name="selectedStudentIds"
                                   value="@s.StudentId"
                                   class="student-checkbox"
                                   id="student-@s.StudentId" />
                            <label for="student-@s.StudentId" class="student-label">
                                <span class="student-name">@s.FullName</span>
                            </label>
                        </div>
                    }
                </div>

                <div class="list-footer">
                    <div class="search-box">
                        <input type="text" id="studentSearch" placeholder="Пребарај студенти..."
                               class="search-input" />
                    </div>
                    <div class="selected-summary">
                        <span id="selectedSummary">Нема избрани студенти</span>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <h3>Нема достапни студенти</h3>
                    <p>Моментално нема достапни студенти за запишување.</p>
                </div>
            }
        </div>

        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="clearSelection()">
                Исчисти избор
            </button>
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
                <span class="btn-text">Запиши избрани студенти</span>
                <span class="btn-loading" id="loadingSpinner"></span>
            </button>
        </div>

        <div class="form-notice">
            <p>Избраните студенти ќе бидат запишани на предметот за наведената академска година и семестар.</p>
        </div>
    </form>
</div>

<style>
    .enrollment-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .header-section {
        background: #4a6fa5;
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .course-info {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-input,
    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
        background-color: white;
    }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

    .form-hint {
        margin-top: 5px;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .section-header {
        background: white;
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .selection-controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .select-all-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .select-all-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .select-all-label {
        font-size: 0.95rem;
        color: #4a6fa5;
        cursor: pointer;
    }

    .selected-count {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .students-container {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .students-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

        .students-list::-webkit-scrollbar {
            width: 6px;
        }

        .students-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .students-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

            .students-list::-webkit-scrollbar-thumb:hover {
                background: #a1a1a1;
            }

    .student-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        margin-bottom: 8px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        transition: background-color 0.2s;
        background-color: #f8f9fa;
    }

        .student-item:hover {
            background-color: #edf2f7;
        }

        .student-item.selected {
            border-color: #28a745;
            background-color: #e8f5e9;
        }

    .student-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .student-label {
        flex: 1;
        cursor: pointer;
    }

    .student-name {
        font-size: 0.95rem;
        font-weight: 500;
        color: #2c3e50;
    }

    .list-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }

    .search-box {
        width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.95rem;
    }

        .search-input:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

    .selected-summary {
        font-size: 0.95rem;
        color: #2c3e50;
        background: #e9ecef;
        padding: 6px 12px;
        border-radius: 4px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

        .empty-state h3 {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 0.95rem;
            color: #6c757d;
        }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
    }

    .btn-secondary,
    .submit-btn {
        padding: 10px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .submit-btn {
        background-color: #28a745;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .submit-btn:hover:not(:disabled) {
            background-color: #218838;
        }

        .submit-btn:disabled {
            background-color: #c3e6cb;
            cursor: not-allowed;
            opacity: 0.7;
        }

    .btn-loading {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid white;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .form-notice {
        background: #e8f4fd;
        padding: 15px;
        border-radius: 4px;
        border-left: 3px solid #17a2b8;
        font-size: 0.9rem;
        color: #2c3e50;
        line-height: 1.5;
    }

    @@media (max-width: 768px) {
        .enrollment-container {
            padding: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .selection-controls {
            width: 100%;
            justify-content: space-between;
        }

        .list-footer {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .search-box {
            width: 100%;
        }

        .form-actions {
            flex-direction: column;
            gap: 15px;
        }

        .btn-secondary,
        .submit-btn {
            width: 100%;
            text-align: center;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        const selectedCountElement = document.getElementById('selectedCount');
        const selectedSummaryElement = document.getElementById('selectedSummary');
        const submitBtn = document.getElementById('submitBtn');
        const studentSearch = document.getElementById('studentSearch');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const enrollmentForm = document.getElementById('enrollmentForm');

        // Иницијализација
        updateSelectionCount();

        // Избери ги сите
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                updateStudentItemState(checkbox);
            });
            updateSelectionCount();
        });

        // Индивидуални избори
        studentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateStudentItemState(this);
                updateSelectAllState();
                updateSelectionCount();
            });
            updateStudentItemState(checkbox);
        });

        // Пребарување
        studentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const studentItems = document.querySelectorAll('.student-item');

            studentItems.forEach(item => {
                const studentName = item.querySelector('.student-name').textContent.toLowerCase();
                item.style.display = studentName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // Поднесување на формулар
        enrollmentForm.addEventListener('submit', function(e) {
            const selectedStudents = document.querySelectorAll('.student-checkbox:checked').length;

            if (selectedStudents === 0) {
                e.preventDefault();
                alert('Ве молиме изберете барем еден студент за запишување.');
                return;
            }

            submitBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            submitBtn.querySelector('.btn-text').textContent = 'Обработка...';
        });

        // Помошни функции
        function updateStudentItemState(checkbox) {
            const studentItem = checkbox.closest('.student-item');
            if (checkbox.checked) {
                studentItem.classList.add('selected');
            } else {
                studentItem.classList.remove('selected');
            }
        }

        function updateSelectAllState() {
            const allChecked = Array.from(studentCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(studentCheckboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        function updateSelectionCount() {
            const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
            const totalCount = studentCheckboxes.length;

            selectedCountElement.textContent = selectedCount;

            selectedSummaryElement.textContent =
                selectedCount === 0 ? 'Нема избрани студенти' :
                selectedCount === totalCount ? `Сите ${totalCount} студенти избрани` :
                `${selectedCount} од ${totalCount} студенти избрани`;

            submitBtn.disabled = selectedCount === 0;
            submitBtn.querySelector('.btn-text').textContent =
                selectedCount === 0 ? 'Запиши избрани студенти' :
                `Запиши ${selectedCount} студент${selectedCount === 1 ? '' : 'и'}`;
        }

        // Исчисти избор
        window.clearSelection = function() {
            if (confirm('Дали сте сигурни дека сакате да го исчистите целиот избор?')) {
                studentCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    updateStudentItemState(checkbox);
                });
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                updateSelectionCount();
            }
        };
    });
</script>